# Исправления проблем сканера

## Проблемы, которые были исправлены

### 1. Проблема с извлечением ссылок

**Описание**: Сканер не обходил ссылки за пределами введенного URL, потому что в методе `_extract_links_from_url` отсутствовала логика извлечения ссылок и форм.

**Исправление**:

- Добавлена полная реализация извлечения ссылок из HTML с помощью BeautifulSoup
- Добавлена обработка относительных ссылок с помощью `urljoin`
- Добавлена проверка принадлежности ссылок к тому же домену
- Добавлено извлечение форм с проверкой наличия полей ввода

**Файл**: `scanner/scanner_fixed.py` (строки 700-750)

### 2. Проблема с применением политик сканирования

**Описание**: При выборе политики сканирования значения не применялись в настройках производительности.

**Исправление**:

- Добавлено автоматическое применение настроек политики к UI при выборе
- Обновляются значения глубины сканирования, параллельных запросов и таймаута
- Обновляются выбранные типы уязвимостей
- Добавлено логирование применения настроек

**Файл**: `views/dashboard_window.py` (метод `on_policy_selected`)

### 3. Проблема с ошибкой matplotlib stats

**Описание**: Ошибка "Error updating matplotlib stats: 'result'" возникала из-за неправильной обработки структуры данных результатов сканирования.

**Исправление**:

- Добавлена обработка ошибок JSON парсинга
- Добавлена поддержка как старой (список), так и новой (словарь) структуры результатов
- Улучшена обработка поля `vulnerabilities` в результатах
- Добавлена защита от ошибок при доступе к данным

**Файл**: `views/dashboard_window.py` (метод `_refresh_stats_with_matplotlib`)

## Структура политик сканирования

### Default Policy (`policies/default.json`)

```json
{
    "name": "Default",
    "enabled_vulns": ["sql", "xss", "csrf"],
    "max_depth": 3,
    "max_concurrent": 5,
    "timeout": 30,
    "stop_on_first_vuln": false
}
```

### Full Scan Policy (`policies/Full Scan.json`)

```json
{
    "name": "Full Scan",
    "enabled_vulns": ["sql", "xss", "csrf"],
    "max_depth": 10,
    "max_concurrent": 20,
    "timeout": 30,
    "stop_on_first_vuln": false
}
```

## Как работает исправленный сканер

1. **Инициализация**: Сканер создается с параметрами из выбранной политики
2. **Краулинг**: Сканер извлекает все ссылки и формы с каждой страницы
3. **Обход**: Сканер обходит ссылки до указанной глубины (max_depth)
4. **Сканирование**: Каждая найденная форма и URL сканируется на уязвимости
5. **Результаты**: Результаты сохраняются в структурированном виде

## Логирование

Добавлено подробное логирование для отслеживания:

- Выбора политик и применения настроек
- Извлечения ссылок и форм
- Обработки ошибок парсинга результатов
- Статистики сканирования

## Тестирование

Для проверки исправлений:

1. Выберите политику "Full Scan" - настройки должны автоматически обновиться
2. Запустите сканирование - сканер должен обойти больше URL
3. Проверьте вкладку "Статистика" - ошибки matplotlib должны исчезнуть
4. Проверьте логи - должны быть записи об извлечении ссылок
